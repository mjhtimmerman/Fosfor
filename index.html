<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fosfor Targets</title>

  <link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;600;700&display=swap" rel="stylesheet"/>
  <script src="https://cdn.tailwindcss.com"></script>

  <script>
    tailwind.config = {
      safelist: ["bg-red-600", "bg-orange-500", "bg-emerald-600"],
      theme: {
        extend: {
          fontFamily: { display: ["Sora", "sans-serif"] },
          colors: { text: "#0F172A", mut: "#64748B" }
        }
      }
    }
  </script>

  <style>
    html, body { height: 100%; }
    body { background: #fff; }
    .solid-dot { background-clip: padding-box; }
  </style>
</head>

<body class="font-display text-text h-screen overflow-hidden">
  <div class="h-full w-full relative">

    <!-- Header -->
    <div class="absolute left-10 top-10 flex items-center gap-6">
      <div class="w-20 h-20 bg-white flex items-center justify-center overflow-hidden">
        <img src="./fosfor-logo.png" alt="Fosfor" class="w-20 h-20 object-contain" onerror="this.style.display='none'">
      </div>
      <h1 class="text-[clamp(44px,5vw,72px)] font-medium tracking-tight leading-none">Fosfor Targets</h1>
    </div>

    <!-- Main -->
<div class="absolute left-0 right-0 top-[160px] bottom-[70px] px-10 flex items-center justify-center">
  <div class="w-full max-w-[1400px]">
      <div class="h-full w-full grid grid-cols-4 gap-[clamp(32px,5vw,96px)] items-start">

        <div class="text-center">
          <div class="text-[clamp(38px,4.2vw,60px)] font-medium mb-6">Leads</div>
          <div class="flex items-center justify-center gap-10">
            <div id="leads" class="text-[clamp(28px,3.2vw,46px)] w-[clamp(120px,9vw,150px)] text-left tabular-nums">-</div>
            <div id="dot_leads" class="solid-dot shrink-0 w-[clamp(110px,10vw,160px)] h-[clamp(110px,10vw,160px)] rounded-full bg-red-600"></div>
          </div>
          <div id="leads_sub" class="mt-8 text-sm leading-snug min-h-[44px]"></div>
        </div>

        <div class="text-center">
          <div class="text-[clamp(38px,4.2vw,60px)] font-medium mb-6">Afspraken</div>
          <div class="flex items-center justify-center gap-10">
            <div id="appointments" class="text-[clamp(28px,3.2vw,46px)] w-[clamp(120px,9vw,150px)] text-left tabular-nums">-</div>
            <div id="dot_appointments" class="solid-dot shrink-0 w-[clamp(110px,10vw,160px)] h-[clamp(110px,10vw,160px)] rounded-full bg-red-600"></div>
          </div>
          <div id="appointments_sub" class="mt-8 text-sm leading-snug min-h-[44px]"></div>
        </div>
        
        <div class="text-center">
          <div class="text-[clamp(38px,4.2vw,60px)] font-medium mb-6">Deals</div>
          <div class="flex items-center justify-center gap-10">
            <div id="deals" class="text-[clamp(28px,3.2vw,46px)] w-[clamp(120px,9vw,150px)] text-left tabular-nums">-</div>
            <div id="dot_deals" class="solid-dot shrink-0 w-[clamp(110px,10vw,160px)] h-[clamp(110px,10vw,160px)] rounded-full bg-red-600"></div>
          </div>
          <div id="deals_sub" class="mt-8 text-sm leading-snug min-h-[44px]"></div>
        </div>

        <div class="text-center">
          <div class="text-[clamp(38px,4.2vw,60px)] font-medium mb-6">Hires</div>
          <div class="flex items-center justify-center gap-10">
            <div id="hires" class="text-[clamp(28px,3.2vw,46px)] w-[clamp(120px,9vw,150px)] text-left tabular-nums">-</div>
            <div id="dot_hires" class="solid-dot shrink-0 w-[clamp(110px,10vw,160px)] h-[clamp(110px,10vw,160px)] rounded-full bg-red-600"></div>
          </div>
          <div id="hires_sub" class="mt-8 text-sm leading-snug min-h-[44px]"></div>
        </div>

      </div>
    </div>
</div>

    <!-- Footer -->
    <div class="absolute left-10 bottom-6 text-xs text-mut">
      <span id="meta_month">Maand: -</span>
      <span> â€¢ </span>
      <span id="meta_updated">Update: -</span>
    </div>

  </div>
  <div class="hidden bg-red-600 bg-orange-500 bg-emerald-600"></div>
  
<script>
  const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRkMJ9uMSSZlXU2Cyrr7GS7HW5lubQANE2_gycg9AJJhL9eTFjn0wBJCn1yGfcvRNoyWerYFvr3s6hr/pub?gid=425498216&single=true&output=csv";
  const TARGETS_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRkMJ9uMSSZlXU2Cyrr7GS7HW5lubQANE2_gycg9AJJhL9eTFjn0wBJCn1yGfcvRNoyWerYFvr3s6hr/pub?gid=1397330974&single=true&output=csv";
  const REFRESH_MS = 60_000;

  const $ = (id) => document.getElementById(id);
  const setText = (id, v) => { const el = $(id); if (el) el.textContent = v; };

  function stripBOM(s){ return s.replace(/^\uFEFF/, ""); }

  function toNum(v){
    const n = Number(String(v ?? "").trim().replace(",", "."));
    return Number.isFinite(n) ? n : 0;
  }

  // ---------- CSV parsing ----------
  function parseCurrentCSV(text){
    const clean = stripBOM(text).trim();
    const lines = clean.split(/\r?\n/).filter(Boolean);
    if (lines.length < 2) throw new Error("Currents CSV bevat geen data-rij.");

    const delim = (lines[0].includes(";") && !lines[0].includes(",")) ? ";" : ",";
    const splitLine = (line) => line.split(delim).map(x => x.trim().replace(/^"|"$/g, ""));

    const headers = splitLine(lines[0]).map(h => h.toLowerCase());
    const row = splitLine(lines[1]); // jij gebruikt bewust de eerste data-rij (currents)

    const idx = (name) => headers.indexOf(name.toLowerCase());
    const get = (name) => {
      const i = idx(name);
      if (i === -1) throw new Error(`Currents kolom '${name}' niet gevonden.`);
      return row[i] ?? "";
    };

    return {
      date: String(get("date")).trim(),
      leads: get("leads"),
      appointments: get("appointments"),
      deals: get("deals"),
      hires: get("hires"),
    };
  }

  function parseTargetsCSV(text){
    const clean = stripBOM(text).trim();
    const lines = clean.split(/\r?\n/).filter(Boolean);
    if (lines.length < 2) throw new Error("Targets CSV bevat geen data-rijen.");

    const delim = (lines[0].includes(";") && !lines[0].includes(",")) ? ";" : ",";
    const splitLine = (line) => line.split(delim).map(x => x.trim().replace(/^"|"$/g, ""));

    const headers = splitLine(lines[0]).map(h => h.toLowerCase());
    const idx = (name) => headers.indexOf(name.toLowerCase());

    const getCell = (row, name) => {
      const i = idx(name);
      if (i === -1) throw new Error(`Targets kolom '${name}' niet gevonden.`);
      return row[i] ?? "";
    };

    // map: { "2026-02": {leads_target: 100, deals_target: 16, hires_target: 20}, ... }
    const map = {};
    for (let r = 1; r < lines.length; r++){
      const row = splitLine(lines[r]);
      const month = String(getCell(row, "month")).trim();
      if (!month) continue;

      map[month] = {
        leads_target: toNum(getCell(row, "leads_target")),
        appointments_target: toNum(getCell(row, "appointments_target")),
        deals_target: toNum(getCell(row, "deals_target")),
        hires_target: toNum(getCell(row, "hires_target")),
      };
    }
    return map;
  }

  // ---------- Logic ----------
  function dotColor(actual, target){
    if (!target || target <= 0) return "#F97316"; // orange
    const pct = actual / target;
    if (pct < 0.60) return "#DC2626"; // red
    if (pct < 0.80) return "#F97316"; // orange
    return "#059669"; // green
}

  // Progress binnen maand op basis van dagen
  function startOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1, 0, 0, 0); }
  function endOfMonth(d){ return new Date(d.getFullYear(), d.getMonth() + 1, 1, 0, 0, 0); }
  function clamp01(x){ return Math.max(0, Math.min(1, x)); }

  function monthProgress(now = new Date()){
    const s = startOfMonth(now).getTime();
    const e = endOfMonth(now).getTime();
    const t = now.getTime();
    return clamp01((t - s) / (e - s));
  }
  
  function startOfWeekMonday(d){
    const x = new Date(d);
    const day = (x.getDay() + 6) % 7; // ma=0 ... zo=6
    x.setDate(x.getDate() - day);
    x.setHours(0,0,0,0);
    return x;
  }

  function isLastWeekOfMonth(now = new Date()){
    const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0); // laatste dag van maand
    const thisWeekStart = startOfWeekMonday(now).getTime();
    const lastWeekStart = startOfWeekMonday(lastDay).getTime();
    return thisWeekStart === lastWeekStart;
  }

  function weekTargetFromMonthTarget(monthTarget, now = new Date()){
    if (!monthTarget || monthTarget <= 0) return 0;

    // laatste week => target = maandtarget
    if (isLastWeekOfMonth(now)) return Math.round(monthTarget);

    const p = monthProgress(now); // je bestaande dag-progress
    return Math.max(0, Math.round(monthTarget * p));
  }

  function remainingText(actual, weekTarget, label){
    if (!weekTarget || weekTarget <= 0) return "";
    const remaining = Math.max(0, Math.ceil(weekTarget - actual));
    if (remaining === 0) return `Op weektarget voor ${label}.`;
    return `Nog ${remaining} te behalen om op weektarget te komen.`;
  }

  async function fetchText(url, ctrl){
    const res = await fetch(url, { cache: "no-store", signal: ctrl.signal });
    if (!res.ok) throw new Error(`Fetch faalt (${res.status}) voor ${url}`);
    return await res.text();
  }

  async function load(){
    const ctrl = new AbortController();
    const t = setTimeout(() => ctrl.abort(), 8000);
    
    try{
      // parallel fetchen
      const [currText, targText] = await Promise.all([
        fetchText(CSV_URL, ctrl),
        fetchText(TARGETS_CSV_URL, ctrl),
      ]);

      const data = parseCurrentCSV(currText);
      const targetsMap = parseTargetsCSV(targText);

      const monthKey = String(data.date || "").trim();
      const monthTargets = targetsMap[monthKey];
      if (!monthTargets) throw new Error(`Geen targets gevonden voor maand '${monthKey}'.`);

      const leads = toNum(data.leads);
      const appointments = toNum(data.appointments);
      const deals = toNum(data.deals);
      const hires = toNum(data.hires);

      // weektarget = maandtarget * maand-progress
      const wTargets = {
        leads: weekTargetFromMonthTarget(monthTargets.leads_target),
        appointments: weekTargetFromMonthTarget(monthTargets.appointments_target),
        deals: weekTargetFromMonthTarget(monthTargets.deals_target),
        hires: weekTargetFromMonthTarget(monthTargets.hires_target),
      };

      setText("leads", `${leads}/${Math.round(monthTargets.leads_target)}`);
      setText("appointments", `${appointments}/${Math.round(monthTargets.appointments_target)}`);
      setText("deals", `${deals}/${Math.round(monthTargets.deals_target)}`);
      setText("hires", `${hires}/${Math.round(monthTargets.hires_target)}`);

      $("dot_leads").style.backgroundColor = dotColor(leads, wTargets.leads);
      $("dot_appointments").style.backgroundColor = dotColor(appointments, wTargets.appointments);
      $("dot_deals").style.backgroundColor = dotColor(deals, wTargets.deals);
      $("dot_hires").style.backgroundColor = dotColor(hires, wTargets.hires);

      setText("leads_sub", remainingText(leads, wTargets.leads, "leads"));
      setText("appointments_sub", remainingText(appointments, wTargets.appointments, "appointments"));
      setText("deals_sub", remainingText(deals, wTargets.deals, "deals"));
      setText("hires_sub", remainingText(hires, wTargets.hires, "hires"));

      setText("meta_month", `Maand: ${monthKey}`);
      setText("meta_updated", `Update: ${new Date().toLocaleString("nl-NL")}`);
    } catch(e){
      setText("meta_month", "Maand: -");
      setText("meta_updated", `Fout: ${e.message || e}`);
    }
      finally {
      clearTimeout(t);
    }
  }
  load();
  setInterval(load, REFRESH_MS);
</script>
