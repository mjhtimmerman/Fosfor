<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fosfor Target Dashboard</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;600;700&display=swap" rel="stylesheet"/>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: "#4F46E5",
            "background-light": "#F8FAFC",
            "card-light": "#FFFFFF",
            "border-light": "#E2E8F0",
            "text-primary-light": "#1E293B",
            "text-secondary-light": "#64748B",
          },
          fontFamily: {
            display: ["Sora", "sans-serif"],
          },
          borderRadius: {
            xl: "1.25rem"
          },
        },
      },
    };
  </script>

  <style>
    html, body { height: 100%; }
  </style>
</head>

<body class="bg-background-light font-display text-text-primary-light flex flex-col h-screen">
  <div class="p-6 flex-grow flex flex-col">
    <div class="max-w-screen-2xl mx-auto w-full flex-grow flex flex-col">

      <!-- Header -->
      <header class="mb-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-4">
            <!-- Vervang logo-pad of haal weg -->
            <div class="w-10 h-10 rounded-full border border-border-light flex items-center justify-center font-bold">
              F
            </div>
            <div>
              <h1 class="text-xl font-bold">Fosfor Targets</h1>
              <p id="subline" class="text-xs text-text-secondary-light mt-1">Laden…</p>
            </div>
          </div>

          <div class="text-xs text-text-secondary-light">
            Auto-refresh: <span class="font-semibold">60s</span>
          </div>
        </div>
      </header>

      <!-- KPI cards -->
      <main class="flex-grow flex flex-col">
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
          <div class="bg-card-light p-4 rounded-xl border border-border-light text-center">
            <h3 class="text-xs font-semibold text-text-secondary-light">Leads</h3>
            <p id="leads_value" class="text-5xl font-bold tracking-tight mt-2">-</p>
            <p id="leads_meta" class="text-xs text-text-secondary-light mt-2">-</p>
            <div class="mt-3 h-2 bg-slate-100 rounded-full overflow-hidden">
              <div id="leads_bar" class="h-full w-0"></div>
            </div>
          </div>

          <div class="bg-card-light p-4 rounded-xl border border-border-light text-center">
            <h3 class="text-xs font-semibold text-text-secondary-light">Deals</h3>
            <p id="deals_value" class="text-5xl font-bold tracking-tight mt-2">-</p>
            <p id="deals_meta" class="text-xs text-text-secondary-light mt-2">-</p>
            <div class="mt-3 h-2 bg-slate-100 rounded-full overflow-hidden">
              <div id="deals_bar" class="h-full w-0"></div>
            </div>
          </div>

          <div class="bg-card-light p-4 rounded-xl border border-border-light text-center">
            <h3 class="text-xs font-semibold text-text-secondary-light">Hires</h3>
            <p id="hires_value" class="text-5xl font-bold tracking-tight mt-2">-</p>
            <p id="hires_meta" class="text-xs text-text-secondary-light mt-2">-</p>
            <div class="mt-3 h-2 bg-slate-100 rounded-full overflow-hidden">
              <div id="hires_bar" class="h-full w-0"></div>
            </div>
          </div>
        </div>

        <!-- Status / Actie (zelfde middenkolom vibe) -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 flex-grow">
          <div class="lg:col-span-8 flex flex-col gap-4">
            <div class="bg-card-light p-4 rounded-xl border border-border-light flex-1">
              <h2 class="text-base font-bold mb-2">Analyse</h2>
              <div id="analysis" class="text-sm text-text-secondary-light">-</div>
            </div>

            <div class="bg-card-light p-4 rounded-xl border border-border-light flex-1">
              <h2 class="text-base font-bold mb-2">Actie</h2>
              <div id="action" class="text-sm text-text-secondary-light">-</div>
            </div>
          </div>

          <div class="lg:col-span-4">
            <div class="bg-card-light p-4 rounded-xl border border-border-light h-full">
              <h2 class="text-base font-bold mb-3">Details</h2>
              <div class="text-sm text-text-secondary-light space-y-2">
                <div class="flex justify-between"><span>Maand</span><span id="month" class="font-semibold text-text-primary-light">-</span></div>
                <div class="flex justify-between"><span>Laatste update</span><span id="updated" class="font-semibold text-text-primary-light">-</span></div>
                <div class="pt-2 border-t border-border-light"></div>
                <div class="flex justify-between"><span>Targets (maand)</span><span class="font-semibold text-text-primary-light" id="targets">-</span></div>
              </div>
            </div>
          </div>
        </div>
      </main>

    </div>
  </div>

<script>
/**
 * 1) Zet hier je gepubliceerde CSV-link (currents tab).
 * Voorbeeld: https://docs.google.com/spreadsheets/d/XXXX/export?format=csv&gid=12345
 */
const CSV_URL = "PASTE_YOUR_CSV_URL_HERE";

/**
 * 2) Targets: pas aan.
 * Stoplicht: >=80% groen, 60-80% oranje, <60% rood.
 */
const TARGETS = {
  leads: 100,
  deals: 8,
  hires: 4
};

const REFRESH_MS = 60_000;

function setText(id, val) {
  const el = document.getElementById(id);
  if (el) el.textContent = (val ?? "-");
}

function clamp(n, min, max) { return Math.max(min, Math.min(max, n)); }

function statusFromPct(pct) {
  if (pct < 0.60) return { label: "Rood",  bar: "bg-red-500",   text: "text-red-600" };
  if (pct < 0.80) return { label: "Oranje", bar: "bg-orange-400", text: "text-orange-600" };
  return { label: "Groen", bar: "bg-emerald-500", text: "text-emerald-600" };
}

function setKpi(kpiName, actual, target) {
  const pct = target > 0 ? (actual / target) : 0;
  const s = statusFromPct(pct);

  // Value
  setText(`${kpiName}_value`, String(actual));

  // Meta
  const pctTxt = (target > 0) ? `${Math.round(pct * 100)}% van target (${target}) • ${s.label}` : "-";
  const metaEl = document.getElementById(`${kpiName}_meta`);
  if (metaEl) {
    metaEl.textContent = pctTxt;
    metaEl.className = `text-xs mt-2 ${s.text}`;
  }

  // Bar
  const barEl = document.getElementById(`${kpiName}_bar`);
  if (barEl) {
    barEl.className = `h-full ${s.bar}`;
    barEl.style.width = `${clamp(pct * 100, 0, 100)}%`;
  }

  return { pct, status: s.label };
}

function csvToRows(text) {
  // Basic CSV parse that handles quoted values minimally
  const lines = text.trim().split(/\r?\n/);
  return lines.map(line => {
    const out = [];
    let cur = "";
    let inQ = false;
    for (let i = 0; i < line.length; i++) {
      const ch = line[i];
      if (ch === '"' ) { inQ = !inQ; continue; }
      if (ch === "," && !inQ) { out.push(cur); cur = ""; continue; }
      cur += ch;
    }
    out.push(cur);
    return out.map(x => x.trim());
  });
}

function toNumber(v) {
  if (v == null) return 0;
  // handle "17" or "17,5"
  const norm = String(v).replace(",", ".");
  const n = Number(norm);
  return Number.isFinite(n) ? n : 0;
}

function buildAnalysis(summary) {
  // Heel simpel, maar functioneel voor kantoor
  const { leads, deals, hires } = summary;
  const flags = [leads, deals, hires].filter(x => x.status !== "Groen").length;

  if (flags === 0) return "Targets liggen op schema. Geen afwijkingen zichtbaar.";
  if (flags === 1) return "Er is 1 KPI onder target. Check focus op de bottleneck in de funnel.";
  return "Meerdere KPI’s onder target. Prioriteit: oorzaak zoeken in volume (leads) vs conversie (deals/hires).";
}

function buildAction(summary) {
  const order = [
    { key: "leads", label: "Leads" },
    { key: "deals", label: "Deals" },
    { key: "hires", label: "Hires" }
  ];

  const worst = order
    .map(o => ({ ...o, pct: summary[o.key].pct }))
    .sort((a,b) => a.pct - b.pct)[0];

  if (worst.pct >= 0.8) return "Geen actie vereist.";
  if (worst.key === "leads") return "Actie: verhoog volume (budget/creatives/targeting) tot minimaal 80% van target.";
  if (worst.key === "deals") return "Actie: optimaliseer conversie lead→deal (follow-up snelheid, kwalificatie, aanbod).";
  return "Actie: optimaliseer conversie deal→hire (proces, matching, intake, closing).";
}

async function load() {
  try {
    const res = await fetch(CSV_URL, { cache: "no-store" });
    if (!res.ok) throw new Error(`CSV fetch failed: ${res.status}`);
    const text = await res.text();

    const rows = csvToRows(text);
    if (rows.length < 2) throw new Error("CSV heeft geen data-rij.");

    const headers = rows[0].map(h => h.toLowerCase());
    const data = rows[1];

    const idx = (name) => headers.indexOf(name.toLowerCase());

    const month = data[idx("date")] ?? "-";
    const leads = toNumber(data[idx("leads")]);
    const deals = toNumber(data[idx("deals")]);
    const hires = toNumber(data[idx("hires")]);

    setText("subline", `Laatste maand uit Sheets: ${month}`);
    setText("month", month);
    setText("updated", new Date().toLocaleString("nl-NL"));
    setText("targets", `Leads ${TARGETS.leads} • Deals ${TARGETS.deals} • Hires ${TARGETS.hires}`);

    const summary = {
      leads: setKpi("leads", leads, TARGETS.leads),
      deals: setKpi("deals", deals, TARGETS.deals),
      hires: setKpi("hires", hires, TARGETS.hires),
    };

    setText("analysis", buildAnalysis(summary));
    setText("action", buildAction(summary));

  } catch (e) {
    console.error(e);
    setText("subline", "Fout bij laden van data (CSV). Check publicatie/URL.");
    setText("analysis", String(e.message || e));
    setText("action", "Controleer of de Sheets-tab is gepubliceerd als CSV en de URL klopt (gid).");
  }
}

load();
setInterval(load, REFRESH_MS);
</script>
</body>
</html>
